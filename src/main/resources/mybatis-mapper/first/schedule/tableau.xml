<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shinvest.ap.schedule.mapper.JobTableauMapper">


<!-- 태블로 프로젝트 인터페이스 삭제 -->
	<delete id="deleteIfProject">
DELETE FROM T_IF_TABLEAU_PROJECT
	</delete>
<!-- 태블로 프로젝트 인터페이스 등록 -->
	<insert id="insertIfProject" parameterType="map">
INSERT INTO PTL.T_IF_TABLEAU_PROJECT (TABLEAU_PROJECT_ID,TABLEAU_PROJECT_NM,TABLEAU_PROJECT_DSC,UP_PROJECT_YN,UP_TABLEAU_PROJECT_ID,TABLEAU_USER_ID,TABLEAU_PROJECT_AUTH,TABLEAU_PROJECT_CNT,TABLEAU_WORKBOOK_CNT,TABLEAU_VIEW_CNT,DATA_SRC_CNT,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT) VALUES
		<foreach collection="project" item="i" separator=",">
(#{i.id}
,#{i.name}
,#{i.description}
,#{i.topLevelProject}
,#{i.parentProjectId}
,#{i.owner.id}
,#{i.contentPermissions},NULL,NULL,NULL,NULL,'Y','I','SYSTEM',NOW(),'SYSTEM',NOW())
		</foreach>
	</insert>
<!-- 삭제 태블로 프로젝트 -->
	<update id="syncDeleteProject">
UPDATE PTL.T_TABLEAU_PROJECT SET
    MODI_SE = 'D',
    USE_YN = 'N',
    MODI_ID = 'SYSTEM',
    MODI_DT = NOW()
WHERE MODI_SE = 'C'
  AND TABLEAU_PROJECT_ID NOT IN (SELECT TABLEAU_PROJECT_ID FROM PTL.T_IF_TABLEAU_PROJECT)
	</update>
<!-- 변경 태블로 프로젝트 -->
	<update id="syncUpdateProject">
UPDATE PTL.T_TABLEAU_PROJECT T SET
    TABLEAU_PROJECT_NM = S.TABLEAU_PROJECT_NM
  , TABLEAU_PROJECT_DSC = S.TABLEAU_PROJECT_DSC
  , UP_PROJECT_YN = S.UP_PROJECT_YN
  , UP_TABLEAU_PROJECT_ID = S.UP_TABLEAU_PROJECT_ID
  , TABLEAU_USER_ID = S.TABLEAU_USER_ID
  , TABLEAU_PROJECT_AUTH = S.TABLEAU_PROJECT_AUTH
  , MODI_SE = 'U'
FROM PTL.T_IF_TABLEAU_PROJECT S
WHERE T.TABLEAU_PROJECT_ID = S.TABLEAU_PROJECT_ID
  AND ( T.TABLEAU_PROJECT_NM != S.TABLEAU_PROJECT_NM
 OR T.TABLEAU_PROJECT_DSC != S.TABLEAU_PROJECT_DSC
 OR T.UP_PROJECT_YN != S.UP_PROJECT_YN
 OR T.UP_TABLEAU_PROJECT_ID != S.UP_TABLEAU_PROJECT_ID
 OR T.TABLEAU_USER_ID != S.TABLEAU_USER_ID)
	</update>
<!-- 신규 태블로 프로젝트 -->
	<insert id="syncInsertProject">
INSERT INTO PTL.T_TABLEAU_PROJECT (TABLEAU_PROJECT_ID,TABLEAU_PROJECT_NM,TABLEAU_PROJECT_DSC,UP_PROJECT_YN,UP_TABLEAU_PROJECT_ID,TABLEAU_USER_ID,TABLEAU_PROJECT_AUTH,TABLEAU_PROJECT_CNT,TABLEAU_WORKBOOK_CNT,TABLEAU_VIEW_CNT,DATA_SRC_CNT,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT)
SELECT
    S.TABLEAU_PROJECT_ID,S.TABLEAU_PROJECT_NM,S.TABLEAU_PROJECT_DSC,S.UP_PROJECT_YN,S.UP_TABLEAU_PROJECT_ID,S.TABLEAU_USER_ID,S.TABLEAU_PROJECT_AUTH,S.TABLEAU_PROJECT_CNT,S.TABLEAU_WORKBOOK_CNT,S.TABLEAU_VIEW_CNT,S.DATA_SRC_CNT,'Y','I','SYSTEM',NOW(),'SYSTEM',NOW()
FROM PTL.T_IF_TABLEAU_PROJECT S
LEFT OUTER JOIN PTL.T_TABLEAU_PROJECT T ON T.TABLEAU_PROJECT_ID = S.TABLEAU_PROJECT_ID
WHERE T.TABLEAU_PROJECT_ID IS NULL
	</insert>
<!-- 태블로 수정 구분 정리 -->
	<update id="updateModiSeProject">
UPDATE PTL.T_TABLEAU_PROJECT SET MODI_SE = CASE MODI_SE WHEN 'D' THEN 'R' ELSE 'C' END WHERE MODI_SE IN ('I','U','D')
	</update>


<!-- 태블로 프로젝트 삭제 처리 -->
	<update id="deleteProject">
UPDATE PTL.T_PROJECT SET
  	USE_YN = 'N'
  , ACTIVE_YN = 'N'
  , MODI_ID = (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'DEFAULT_USER_ID' AND CODE_ID = 'PROJECT')
  , MODI_DT = NOW()
WHERE USE_YN = 'Y' AND TABLEAU_PROJECT_ID IN (SELECT TABLEAU_PROJECT_ID FROM T_TABLEAU_PROJECT WHERE MODI_SE = 'D')
	</update>
	<insert id="deleteProjectHist">
INSERT INTO PTL.T_PROJECT_HIST (HIST_DT,PROJECT_ID,VER,PROJECT_NM,PROJECT_CL,PROJECT_TY,PROJECT_SE,DEPT_CODE,PCPT_INFO,MGR_INFO,START_DT,END_DT,PROJECT_DSC,PROJECT_STAT,ORD_SEQ,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,PROJECT_DATA,DEPT_INFO,TABLEAU_PROJECT_ID,PROJECT_RSRC,ACTIVE_YN,LAST_VER_YN,APRV_STAT,MAIN_PICR_ID,SUB_PICR_ID)
SELECT NOW(), PROJECT_ID,VER,PROJECT_NM,PROJECT_CL,PROJECT_TY,PROJECT_SE,DEPT_CODE,PCPT_INFO,MGR_INFO,START_DT,END_DT,PROJECT_DSC,PROJECT_STAT,ORD_SEQ,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,PROJECT_DATA,DEPT_INFO,TABLEAU_PROJECT_ID,PROJECT_RSRC,ACTIVE_YN,LAST_VER_YN,APRV_STAT,MAIN_PICR_ID,SUB_PICR_ID
FROM PTL.T_PROJECT
WHERE USE_YN = 'N' AND TABLEAU_PROJECT_ID IN (SELECT TABLEAU_PROJECT_ID FROM T_TABLEAU_PROJECT WHERE MODI_SE = 'D')
	</insert>
<!-- 수정 태블로 조회 -->
	<select id="selectModiProject" resultType="string">
SELECT P.PROJECT_ID
FROM PTL.T_TABLEAU_PROJECT T
JOIN PTL.T_PROJECT P ON T.TABLEAU_PROJECT_ID = P.TABLEAU_PROJECT_ID
WHERE T.MODI_SE = 'U' AND (T.TABLEAU_PROJECT_NM != P.PROJECT_NM OR T.TABLEAU_PROJECT_DSC != P.PROJECT_DSC)
	</select>
	<update id="updateModiProject">
UPDATE PTL.T_PROJECT T SET
    PROJECT_NM = S.TABLEAU_PROJECT_NM
  , PROJECT_DSC = S.TABLEAU_PROJECT_DSC
  , MODI_ID = (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'DEFAULT_USER_ID' AND CODE_ID = 'PROJECT')
  , MODI_DT = NOW()
FROM PTL.T_TABLEAU_PROJECT S
WHERE T.TABLEAU_PROJECT_ID = S.TABLEAU_PROJECT_ID
  AND ( T.PROJECT_NM != S.TABLEAU_PROJECT_NM
 OR T.PROJECT_DSC != S.TABLEAU_PROJECT_DSC)
	</update>
	<insert id="insertProjectHist" parameterType="string">
INSERT INTO PTL.T_PROJECT_HIST (HIST_DT,PROJECT_ID,VER,PROJECT_NM,PROJECT_CL,PROJECT_TY,PROJECT_SE,DEPT_CODE,PCPT_INFO,MGR_INFO,START_DT,END_DT,PROJECT_DSC,PROJECT_STAT,ORD_SEQ,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,PROJECT_DATA,DEPT_INFO,TABLEAU_PROJECT_ID,PROJECT_RSRC,ACTIVE_YN,LAST_VER_YN,APRV_STAT,MAIN_PICR_ID,SUB_PICR_ID)
SELECT NOW(), PROJECT_ID,VER,PROJECT_NM,PROJECT_CL,PROJECT_TY,PROJECT_SE,DEPT_CODE,PCPT_INFO,MGR_INFO,START_DT,END_DT,PROJECT_DSC,PROJECT_STAT,ORD_SEQ,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,PROJECT_DATA,DEPT_INFO,TABLEAU_PROJECT_ID,PROJECT_RSRC,ACTIVE_YN,LAST_VER_YN,APRV_STAT,MAIN_PICR_ID,SUB_PICR_ID
FROM PTL.T_PROJECT
WHERE PROJECT_ID = #{projectId}
	</insert>
<!-- 신규 태블로 조회 -->
	<select id="selectNewProject" resultType="projectModel">
SELECT
    TABLEAU_PROJECT_ID
  , TABLEAU_PROJECT_NM AS PROJECT_NM
  , TABLEAU_PROJECT_DSC AS PROJECT_DSC
FROM T_TABLEAU_PROJECT
WHERE MODI_SE = 'I'
	</select>
	<insert id="insertNewProject" parameterType="projectModel">
INSERT INTO PTL.T_PROJECT (PROJECT_ID,VER,PROJECT_NM,PROJECT_TY,PROJECT_SE,START_DT,END_DT,PROJECT_DSC,PROJECT_STAT,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,TABLEAU_PROJECT_ID,ACTIVE_YN,LAST_VER_YN,APRV_STAT,MAIN_PICR_ID)
SELECT 
#{projectId},0,#{projectNm},'VW','COM',NOW(),TO_TIMESTAMP('9999-12-31 23:59:59','YYYY-MM-DD HH24:MI:SS'),#{projectDsc},'C','Y',CODE_NM,NOW(),CODE_NM,NOW(),#{tableauProjectId},'Y','Y','C',CODE_NM
FROM T_CODE WHERE GROUP_ID = 'DEFAULT_USER_ID' AND CODE_ID = 'PROJECT'
	</insert>







<!-- 태블로 워크북 인터페이스 삭제 -->
	<delete id="deleteIfWorkbook">
DELETE FROM T_IF_TABLEAU_WORKBOOK
	</delete>
<!-- 태블로 워크북 인터페이스 등록 -->
	<insert id="insertIfWorkbook" parameterType="map">
INSERT INTO PTL.T_IF_TABLEAU_WORKBOOK (TABLEAU_WORKBOOK_ID,TABLEAU_WORKBOOK_NM,TABLEAU_WORKBOOK_DSC,TABLEAU_WEB_URL,TABLEAU_VIEW_ID,TABLEAU_PROJECT_ID,TABLEAU_USER_ID,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT) VALUES
		<foreach collection="workbook" item="i" separator=",">
(#{i.id}
,#{i.name}
,#{i.description}
,#{i.webpageUrl}
,#{i.defaultViewId}
,#{i.project.id}
,#{i.owner.id},'Y','I','SYSTEM',NOW(),'SYSTEM',NOW())
		</foreach>
	</insert>
<!-- 삭제 워크북 프로젝트 -->
	<update id="syncDeleteWorkbook">
UPDATE PTL.T_TABLEAU_WORKBOOK SET
    MODI_SE = 'D',
    USE_YN = 'N',
    MODI_ID = 'SYSTEM',
    MODI_DT = NOW()
WHERE MODI_SE = 'C'
  AND TABLEAU_WORKBOOK_ID NOT IN (SELECT TABLEAU_WORKBOOK_ID FROM PTL.T_IF_TABLEAU_WORKBOOK)
	</update>
<!-- 변경 워크북 프로젝트 -->
	<update id="syncUpdateWorkbook">
UPDATE PTL.T_TABLEAU_WORKBOOK T SET
    TABLEAU_WORKBOOK_NM = S.TABLEAU_WORKBOOK_NM
  , TABLEAU_WORKBOOK_DSC = S.TABLEAU_WORKBOOK_DSC
  , TABLEAU_WEB_URL = S.TABLEAU_WEB_URL
  , TABLEAU_VIEW_ID = S.TABLEAU_VIEW_ID
  , TABLEAU_PROJECT_ID = S.TABLEAU_PROJECT_ID
  , TABLEAU_USER_ID = S.TABLEAU_USER_ID
  , MODI_SE = 'U'
FROM PTL.T_IF_TABLEAU_WORKBOOK S
WHERE T.TABLEAU_WORKBOOK_ID = S.TABLEAU_WORKBOOK_ID
  AND ( T.TABLEAU_WORKBOOK_NM != S.TABLEAU_WORKBOOK_NM
 OR T.TABLEAU_WORKBOOK_DSC != S.TABLEAU_WORKBOOK_DSC
 OR T.TABLEAU_WEB_URL != S.TABLEAU_WEB_URL
 OR T.TABLEAU_VIEW_ID != S.TABLEAU_VIEW_ID
 OR T.TABLEAU_PROJECT_ID != S.TABLEAU_PROJECT_ID
 OR T.TABLEAU_USER_ID != S.TABLEAU_USER_ID)
	</update>
<!-- 신규 워크북 프로젝트 -->
	<insert id="syncInsertWorkbook">
INSERT INTO PTL.T_TABLEAU_WORKBOOK (TABLEAU_WORKBOOK_ID,TABLEAU_WORKBOOK_NM,TABLEAU_WORKBOOK_DSC,TABLEAU_WEB_URL,TABLEAU_VIEW_ID,TABLEAU_PROJECT_ID,TABLEAU_USER_ID,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT)
SELECT
    S.TABLEAU_WORKBOOK_ID,S.TABLEAU_WORKBOOK_NM,S.TABLEAU_WORKBOOK_DSC,S.TABLEAU_WEB_URL,S.TABLEAU_VIEW_ID,S.TABLEAU_PROJECT_ID,S.TABLEAU_USER_ID,'Y','I','SYSTEM',NOW(),'SYSTEM',NOW()
FROM PTL.T_IF_TABLEAU_WORKBOOK S
LEFT OUTER JOIN PTL.T_TABLEAU_WORKBOOK T ON T.TABLEAU_WORKBOOK_ID = S.TABLEAU_WORKBOOK_ID
WHERE T.TABLEAU_WORKBOOK_ID IS NULL
	</insert>
<!-- 워크북 수정 구분 정리 -->
	<update id="updateModiSeWorkbook">
UPDATE PTL.T_TABLEAU_WORKBOOK SET MODI_SE = CASE MODI_SE WHEN 'D' THEN 'R' ELSE 'C' END WHERE MODI_SE IN ('I','U','D')
	</update>


<!-- 삭제 워크북을 리포트에서 USE_YN ='N' -->
	<update id="deleteReport">
UPDATE PTL.T_REPORT SET
    ACTIVE_YN = 'N'
  , USE_YN = 'N'
  , MODI_ID = (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'DEFAULT_USER_ID' AND CODE_ID = 'REPORT')
  , MODI_DT = NOW()
WHERE USE_YN = 'Y' AND TABLEAU_WORKBOOK_ID IN (SELECT TABLEAU_WORKBOOK_ID FROM T_TABLEAU_WORKBOOK WHERE MODI_SE = 'D')
	</update>
	<insert id="deleteReportHist">
INSERT INTO PTL.T_REPORT_HIST (HIST_DT,REPORT_ID,VER,PROJECT_ID,REPORT_NM,REPORT_CL,REPORT_TY,REPORT_SE,WRK_CAT,REPORT_DSC,REPORT_STAT,REPORT_URL,REPORT_ATTR,PREVIEW_URL,FILE_ID,DEPT_CODE,PCPT_INFO,MGR_INFO,SANCTN_INFO,RQST_RESN,EXECUT_CYCLE,ACTIVE_YN,ATMC_APRV_YN,ORD_SEQ,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,ORGN_REPORT_ID,ORGN_REPORT_VER,DEPT_INFO,TABLEAU_WORKBOOK_ID,DEPT_MNG_YN,VIEW_CNT,MAIN_PICR_ID,SUB_PICR_ID)
SELECT NOW(), REPORT_ID,VER,PROJECT_ID,REPORT_NM,REPORT_CL,REPORT_TY,REPORT_SE,WRK_CAT,REPORT_DSC,REPORT_STAT,REPORT_URL,REPORT_ATTR,PREVIEW_URL,FILE_ID,DEPT_CODE,PCPT_INFO,MGR_INFO,SANCTN_INFO,RQST_RESN,EXECUT_CYCLE,ACTIVE_YN,ATMC_APRV_YN,ORD_SEQ,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,ORGN_REPORT_ID,ORGN_REPORT_VER,DEPT_INFO,TABLEAU_WORKBOOK_ID,DEPT_MNG_YN,VIEW_CNT,MAIN_PICR_ID,SUB_PICR_ID
FROM PTL.T_REPORT
WHERE USE_YN = 'N' AND TABLEAU_WORKBOOK_ID IN (SELECT TABLEAU_WORKBOOK_ID FROM T_TABLEAU_WORKBOOK WHERE MODI_SE = 'D')
	</insert>
<!-- 수정 태블로 조회 -->
	<select id="selectModiReport" resultType="string">
SELECT P.REPORT_ID
FROM T_TABLEAU_WORKBOOK T
JOIN PTL.T_REPORT P ON T.TABLEAU_WORKBOOK_ID = P.TABLEAU_WORKBOOK_ID
WHERE T.MODI_SE = 'U' AND (T.TABLEAU_WORKBOOK_NM != P.REPORT_NM OR T.TABLEAU_WORKBOOK_URL != P.REPORT_URL)
	</select>
	<update id="updateModiReport">
UPDATE PTL.T_REPORT T SET
    REPORT_NM = S.TABLEAU_WORKBOOK_NM
  , REPORT_URL = S.TABLEAU_WORKBOOK_URL
  , MODI_ID = (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'DEFAULT_USER_ID' AND CODE_ID = 'REPORT')
  , MODI_DT = NOW()
FROM PTL.T_TABLEAU_WORKBOOK S
WHERE T.TABLEAU_WORKBOOK_ID = S.TABLEAU_WORKBOOK_ID
  AND ( T.REPORT_NM != S.TABLEAU_WORKBOOK_NM
 OR T.REPORT_URL != S.TABLEAU_WORKBOOK_URL)
	</update>
	<insert id="insertReportHist" parameterType="string">
INSERT INTO PTL.T_REPORT_HIST (HIST_DT,REPORT_ID,VER,PROJECT_ID,REPORT_NM,REPORT_CL,REPORT_TY,REPORT_SE,WRK_CAT,REPORT_DSC,REPORT_STAT,REPORT_URL,REPORT_ATTR,PREVIEW_URL,FILE_ID,DEPT_CODE,PCPT_INFO,MGR_INFO,SANCTN_INFO,RQST_RESN,EXECUT_CYCLE,ACTIVE_YN,ATMC_APRV_YN,ORD_SEQ,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,ORGN_REPORT_ID,ORGN_REPORT_VER,DEPT_INFO,TABLEAU_WORKBOOK_ID,DEPT_MNG_YN,VIEW_CNT,MAIN_PICR_ID,SUB_PICR_ID)
SELECT NOW(), REPORT_ID,VER,PROJECT_ID,REPORT_NM,REPORT_CL,REPORT_TY,REPORT_SE,WRK_CAT,REPORT_DSC,REPORT_STAT,REPORT_URL,REPORT_ATTR,PREVIEW_URL,FILE_ID,DEPT_CODE,PCPT_INFO,MGR_INFO,SANCTN_INFO,RQST_RESN,EXECUT_CYCLE,ACTIVE_YN,ATMC_APRV_YN,ORD_SEQ,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,ORGN_REPORT_ID,ORGN_REPORT_VER,DEPT_INFO,TABLEAU_WORKBOOK_ID,DEPT_MNG_YN,VIEW_CNT,MAIN_PICR_ID,SUB_PICR_ID
FROM PTL.T_REPORT
WHERE REPORT_ID = #{reportId}
	</insert>
<!-- 신규 태블로 조회 -->
	<select id="selectNewReport" resultType="reportModel">
SELECT
    W.TABLEAU_WORKBOOK_ID
  , W.TABLEAU_WORKBOOK_NM AS REPORT_NM
  , W.TABLEAU_WORKBOOK_DSC AS REPORT_DSC
  , W.TABLEAU_WORKBOOK_URL AS REPORT_URL
  , P.PROJECT_ID
FROM T_TABLEAU_WORKBOOK W
LEFT OUTER JOIN T_TABLEAU_PROJECT T ON W.TABLEAU_PROJECT_ID = T.TABLEAU_PROJECT_ID 
LEFT OUTER JOIN T_PROJECT P ON T.TABLEAU_PROJECT_ID = P.TABLEAU_PROJECT_ID
WHERE W.MODI_SE = 'I'
	</select>
	<insert id="insertNewReport" parameterType="reportModel">
INSERT INTO PTL.T_REPORT (REPORT_ID,VER,PROJECT_ID,REPORT_NM,REPORT_DSC,REPORT_URL,PCPT_INFO,MGR_INFO,ACTIVE_YN,ATMC_APRV_YN,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,DEPT_INFO,TABLEAU_WORKBOOK_ID,MAIN_PICR_ID)
SELECT
#{reportId},0,#{projectId},#{reportNm},#{reportDsc},#{reportUrl},'{"ids":[],"list":{"userList":[],"deptList":[],"groupList":[]}}'::JSON,'{"ids":[],"list":{"userList":[],"deptList":[],"groupList":[]}}'::JSON,'N','N','Y',CODE_NM,NOW(),CODE_NM,NOW(),'{"ids": [], "list": {"deptList": [], "userList": [], "groupList": []}}'::JSON,#{tableauWorkbookId},CODE_NM
FROM T_CODE WHERE GROUP_ID = 'DEFAULT_USER_ID' AND CODE_ID = 'REPORT'
	</insert>








<!-- 태블로 뷰 정보 연동을 위해 워크북 ID 조회 -->
	<select id="selectWorkbook" resultType="workbookModel">
SELECT
    TABLEAU_WORKBOOK_ID
  , TABLEAU_WORKBOOK_NM
  , TABLEAU_WORKBOOK_DSC
  , TABLEAU_WORKBOOK_URL
  , TABLEAU_WEB_URL
  , TABLEAU_VIEW_ID
  , TABLEAU_PROJECT_ID
  , TABLEAU_USER_ID
  , FILE_ID
  , USE_YN
  , MODI_SE
  , RGST_ID
  , RGST_DT
  , MODI_ID
  , MODI_DT
  , FILE_URL
FROM PTL.T_TABLEAU_WORKBOOK WHERE USE_YN = 'Y'
	</select>
<!-- 태블로 워크북 기본 뷰 업데이트 -->
	<update id="updateWorkbookDefaultView" parameterType="workbookModel">
UPDATE PTL.T_TABLEAU_WORKBOOK SET
    TABLEAU_WORKBOOK_URL = #{tableauWorkbookUrl}
  , TABLEAU_VIEW_ID = #{tableauViewId}
WHERE TABLEAU_WORKBOOK_ID = #{tableauWorkbookId}
	</update>
	<update id="updateReportDefaultView" parameterType="workbookModel">
UPDATE PTL.T_REPORT SET
    REPORT_URL = #{tableauWorkbookUrl}
WHERE TABLEAU_WORKBOOK_ID = #{tableauWorkbookId}
	</update>
<!-- 태블로 뷰 인터페이스 삭제 -->
	<delete id="deleteIfView">
DELETE FROM T_IF_TABLEAU_VIEW
	</delete>
<!-- 태블로 뷰 인터페이스 등록 -->
	<insert id="insertIfView" parameterType="map">
INSERT INTO PTL.T_IF_TABLEAU_VIEW (TABLEAU_VIEW_ID,TABLEAU_VIEW_NM,TABLEAU_VIEW_URL,TABLEAU_WORKBOOK_ID,TABLEAU_USER_ID,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT) VALUES
		<foreach collection="view" item="i" separator=",">
(#{i.id}
,#{i.name}
,#{i.contentUrl}
,#{i.workbook.id}
,#{i.owner.id},'Y','I','SYSTEM',NOW(),'SYSTEM',NOW())
		</foreach>
	</insert>
<!-- 삭제 뷰 프로젝트 -->
	<update id="syncDeleteView" parameterType="string">
UPDATE PTL.T_TABLEAU_VIEW SET
    MODI_SE = 'D',
    USE_YN = 'N',
    MODI_ID = 'SYSTEM',
    MODI_DT = NOW()
WHERE MODI_SE = 'C'
  AND TABLEAU_VIEW_ID NOT IN (SELECT TABLEAU_VIEW_ID FROM PTL.T_IF_TABLEAU_VIEW)
  AND TABLEAU_WORKBOOK_ID = #{tableauWorkbookId}
	</update>
<!-- 변경 뷰 프로젝트 -->
	<update id="syncUpdateView">
UPDATE PTL.T_TABLEAU_VIEW T SET
    TABLEAU_VIEW_NM = S.TABLEAU_VIEW_NM
  , TABLEAU_VIEW_URL = S.TABLEAU_VIEW_URL
  , TABLEAU_WORKBOOK_ID = S.TABLEAU_WORKBOOK_ID
  , TABLEAU_USER_ID = S.TABLEAU_USER_ID
  , MODI_SE = 'U'
FROM PTL.T_IF_TABLEAU_VIEW S
WHERE T.TABLEAU_VIEW_ID = S.TABLEAU_VIEW_ID
  AND ( T.TABLEAU_VIEW_NM != S.TABLEAU_VIEW_NM
 OR T.TABLEAU_VIEW_URL != S.TABLEAU_VIEW_URL
 OR T.TABLEAU_WORKBOOK_ID != S.TABLEAU_WORKBOOK_ID
 OR T.TABLEAU_USER_ID != S.TABLEAU_USER_ID)
	</update>
<!-- 신규 뷰 프로젝트 -->
	<insert id="syncInsertView">
INSERT INTO PTL.T_TABLEAU_VIEW (TABLEAU_VIEW_ID,TABLEAU_VIEW_NM,TABLEAU_VIEW_URL,TABLEAU_WORKBOOK_ID,TABLEAU_USER_ID,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT)
SELECT
    S.TABLEAU_VIEW_ID,S.TABLEAU_VIEW_NM,S.TABLEAU_VIEW_URL,S.TABLEAU_WORKBOOK_ID,S.TABLEAU_USER_ID,'Y','I','SYSTEM',NOW(),'SYSTEM',NOW()
FROM PTL.T_IF_TABLEAU_VIEW S
LEFT OUTER JOIN PTL.T_TABLEAU_VIEW T ON T.TABLEAU_VIEW_ID = S.TABLEAU_VIEW_ID
WHERE T.TABLEAU_VIEW_ID IS NULL
	</insert>
<!-- 부서 수정 구분 정리 -->
	<update id="updateModiSeView">
UPDATE PTL.T_TABLEAU_VIEW SET MODI_SE = CASE MODI_SE WHEN 'D' THEN 'R' ELSE 'C' END WHERE MODI_SE IN ('I','U','D')
	</update>





<!-- 태블로 사용자 인터페이스 삭제 -->
	<delete id="deleteIfUser">
DELETE FROM T_IF_TABLEAU_USER
	</delete>
<!-- 태블로 사용자 인터페이스 등록 -->
	<insert id="insertIfUser" parameterType="map">
INSERT INTO PTL.T_IF_TABLEAU_USER (TABLEAU_USER_ID,TABLEAU_USER_NM,USER_ID,TABLEAU_PW,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT) VALUES
		<foreach collection="user" item="i" separator=",">
(#{i.id}
,#{i.fullName}
,#{i.name}
,#{i.password},'Y','I','SYSTEM',NOW(),'SYSTEM',NOW())
		</foreach>
	</insert>
<!-- 삭제 사용자 프로젝트 -->
	<update id="syncDeleteUser">
UPDATE PTL.T_TABLEAU_USER SET
    MODI_SE = 'D',
    USE_YN = 'N',
    MODI_ID = 'SYSTEM',
    MODI_DT = NOW()
WHERE MODI_SE = 'C'
  AND TABLEAU_USER_ID NOT IN (SELECT TABLEAU_USER_ID FROM PTL.T_IF_TABLEAU_USER)
	</update>
<!-- 변경 사용자 프로젝트 -->
	<update id="syncUpdateUser">
UPDATE PTL.T_TABLEAU_USER T SET
    TABLEAU_USER_NM = S.TABLEAU_USER_NM
  , USER_ID = S.USER_ID
  , TABLEAU_PW = S.TABLEAU_PW
  , MODI_SE = 'U'
FROM PTL.T_IF_TABLEAU_USER S
WHERE T.TABLEAU_USER_ID = S.TABLEAU_USER_ID
  AND ( T.TABLEAU_USER_NM != S.TABLEAU_USER_NM
 OR T.USER_ID != S.USER_ID
 OR T.TABLEAU_PW != S.TABLEAU_PW)
	</update>
<!-- 신규 사용자 프로젝트 -->
	<insert id="syncInsertUser">
INSERT INTO PTL.T_TABLEAU_USER (TABLEAU_USER_ID,TABLEAU_USER_NM,USER_ID,TABLEAU_PW,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT)
SELECT
    S.TABLEAU_USER_ID,S.TABLEAU_USER_NM,S.USER_ID,S.TABLEAU_PW,'Y','I','SYSTEM',NOW(),'SYSTEM',NOW()
FROM PTL.T_IF_TABLEAU_USER S
LEFT OUTER JOIN PTL.T_TABLEAU_USER T ON T.TABLEAU_USER_ID = S.TABLEAU_USER_ID
WHERE T.TABLEAU_USER_ID IS NULL
	</insert>
<!-- 부서 수정 구분 정리 -->
	<update id="updateModiSeUser">
UPDATE PTL.T_TABLEAU_USER SET MODI_SE = CASE MODI_SE WHEN 'D' THEN 'R' ELSE 'C' END WHERE MODI_SE IN ('I','U','D')
	</update>







<!-- HR 사용자별 태블로 계정 -->
	<select id="selectUserList" resultType="memberModel">
SELECT U.USER_ID, U.USER_NM, U.DEPT_CODE, U.USE_YN, D.DEPT_NM, L.TABLEAU_ID
FROM T_USER U
LEFT OUTER JOIN T_LICENSE L ON U.USER_ID = L.USER_ID AND L.LICENSE_TY = 'USER' AND L.LICENSE_SE = 'TABLEAU'
LEFT OUTER JOIN T_DEPT D ON U.DEPT_CODE = D.DEPT_CODE
WHERE L.TABLEAU_ID IS NULL AND U.USE_YN = 'Y'
ORDER BY U.USER_ID
	</select>

	<insert id="insertLicense" parameterType="licenseModel">
INSERT INTO T_LICENSE (LICENSE_ID,TABLEAU_ID,LICENSE_DSC,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,LICENSE_TY,LICENSE_SE,USER_ID)
SELECT
#{licenseId},#{tableauId},#{licenseDsc},'Y',CODE_NM,NOW(),CODE_NM,NOW(),#{licenseTy},#{licenseSe},#{userId}
FROM T_CODE WHERE GROUP_ID = 'DEFAULT_USER_ID' AND CODE_ID = 'LICENSE'
	</insert>






<!-- 워크북 프리뷰 이미지 -->
	<update id="updateWorkbookPreview" parameterType="fileModel">
UPDATE PTL.T_TABLEAU_WORKBOOK SET
    FILE_ID = #{fileId}
  , FILE_URL = #{fileUrl}
  , MODI_ID = 'SYSTEM'
  , MODI_DT = NOW()
WHERE TABLEAU_WORKBOOK_ID = #{refId}
	</update>

	<update id="updateReportPreview" parameterType="fileModel">
UPDATE PTL.T_REPORT SET
    FILE_ID = #{fileId}
  , PREVIEW_URL = '/file/preview/'||#{fileUrl}
WHERE TABLEAU_WORKBOOK_ID = #{refId}
	</update>

	<insert id="insertFile" parameterType="fileModel">
INSERT INTO PTL.T_FILE (FILE_ID,STORAGE_SE,SAVE_PATH,SAVE_FILE_NM,FILE_NM,FILE_EXTSN,FILE_SIZE,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,BUCKET_NM,FILE_URL,FILE_CL,REF_ID,ATMC_DEL_YN,ATMC_DEL_DT) VALUES
(#{fileId},#{storageSe},#{savePath},#{saveFileNm},#{fileNm},#{fileExtsn},#{fileSize},'Y','SYSTEM',NOW(),'SYSTEM',NOW(),#{bucketNm},#{fileUrl},#{fileCl},#{refId}
  , CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')::INTEGER THEN 'Y' ELSE 'N' END
  , CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')::INTEGER
         THEN CURRENT_DATE + (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'PD')::INTERVAL
    ELSE NULL END
)
	</insert>
	
	<update id="updateFile" parameterType="fileModel">
UPDATE PTL.T_FILE SET
    FILE_SIZE = #{fileSize}
  , ATMC_DEL_YN = CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')::INTEGER THEN 'Y' ELSE 'N' END
  , ATMC_DEL_DT = CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')::INTEGER
                       THEN CURRENT_DATE + (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'PD')::INTERVAL
                  ELSE NULL END
  , MODI_ID = 'SYSTEM'
  , MODI_DT = NOW()
WHERE FILE_ID = #{fileId}
	</update>
	
	<select id="selectFile" parameterType="string" resultType="fileModel">
SELECT
    FILE_ID
  , STORAGE_SE
  , SAVE_PATH
  , SAVE_FILE_NM
  , FILE_NM
  , FILE_EXTSN
  , FILE_SIZE
  , USE_YN
  , RGST_ID
  , RGST_DT
  , MODI_ID
  , MODI_DT
  , BUCKET_NM
  , FILE_URL
  , FILE_CL
  , SAVE_FILE_VER
  , REF_ID
  , REF_VER::TEXT
  , ATMC_DEL_YN
  , ATMC_DEL_DT
FROM PTL.T_FILE
WHERE USE_YN = 'Y' AND FILE_ID = #{fileId}
	</select>


	<select id="selectWorkbookViewFile" resultType="workbookModel">
SELECT
    W.TABLEAU_WORKBOOK_ID
  , W.TABLEAU_WORKBOOK_NM
  , W.TABLEAU_WORKBOOK_DSC
  , W.TABLEAU_WORKBOOK_URL
  , W.TABLEAU_WEB_URL
  , W.TABLEAU_VIEW_ID
  , W.TABLEAU_PROJECT_ID
  , W.TABLEAU_USER_ID
  , F.FILE_ID
  , W.USE_YN
  , W.MODI_SE
  , W.RGST_ID
  , W.RGST_DT
  , W.MODI_ID
  , W.MODI_DT
  , F.FILE_URL
FROM PTL.T_TABLEAU_WORKBOOK W
LEFT OUTER JOIN PTL.T_FILE F ON W.TABLEAU_WORKBOOK_ID = F.REF_ID AND F.FILE_CL = 'VIEW' AND W.USE_YN = 'Y'
	</select>

</mapper>
