<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shinvest.ap.schedule.mapper.JobUserPhotoMapper">

<!-- 사용자 정보 조회 -->
	<select id="selectUser" parameterType="string" resultType="memberModel">
SELECT
    USER_ID, FILE_URL
FROM T_USER
WHERE USE_YN = 'Y' AND USER_ID = #{userId}
	</select>

<!-- 신규 파일 정보 INSERT -->
	<insert id="insertFile" parameterType="fileModel">
INSERT INTO T_FILE (FILE_ID,STORAGE_SE,SAVE_PATH,SAVE_FILE_NM,FILE_NM,FILE_EXTSN,FILE_SIZE,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,BUCKET_NM,FILE_URL,FILE_CL,REF_ID,ATMC_DEL_YN,ATMC_DEL_DT) VALUES
(#{fileId},#{storageSe},#{savePath},#{saveFileNm},#{fileNm},#{fileExtsn},#{fileSize},'Y','SYSTEM',NOW(),'SYSTEM',NOW(),#{bucketNm},#{fileUrl},#{fileCl},#{refId}
  , CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')::INTEGER THEN 'Y' ELSE 'N' END
  , CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')::INTEGER
         THEN CURRENT_DATE + (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'PD')::INTERVAL
    ELSE NULL END
)
	</insert>

<!-- 사용자 파일 정보 UPDATE -->
	<update id="updateUserFileInfo" parameterType="fileModel">
UPDATE T_USER SET
    FILE_URL = #{fileUrl}
  , MODI_ID = 'SYSTEM'
  , MODI_DT = NOW()
WHERE USER_ID = #{refId}
	</update>

<!-- 기존 파일 정보 조회 -->
	<select id="selectFile" parameterType="string" resultType="fileModel">
SELECT
    FILE_ID,STORAGE_SE,SAVE_PATH,SAVE_FILE_NM,FILE_NM,FILE_EXTSN,FILE_SIZE,USE_YN,RGST_ID,RGST_DT,MODI_ID,MODI_DT,BUCKET_NM,FILE_URL,FILE_CL,REF_ID,REF_VER::TEXT,ATMC_DEL_YN,ATMC_DEL_DT
FROM T_FILE
WHERE FILE_CL = 'PHOTO' AND USE_YN = 'Y' AND FILE_URL = #{fileUrl}
ORDER BY FILE_ID
	</select>

<!-- 변경 파일 정보 UPDATE -->
	<update id="updateFile" parameterType="fileModel">
UPDATE T_FILE SET
    FILE_SIZE = #{fileSize}
  , ATMC_DEL_YN = CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')::INTEGER THEN 'Y' ELSE 'N' END
  , ATMC_DEL_DT = CASE WHEN #{fileSize} > (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'LIMIT')::INTEGER
                       THEN CURRENT_DATE + (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'FILE' AND CODE_ID = 'PD')::INTERVAL
                  ELSE NULL END
  , MODI_ID = 'SYSTEM'
  , MODI_DT = NOW()
WHERE FILE_CL = 'PHOTO' AND FILE_URL = #{fileUrl} AND REF_ID = #{refId}
	</update>

</mapper>
