<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shinvest.ap.schedule.mapper.JobDeptClMapper">



<!-- 부서 분류 인터페이스 삭제 -->
	<delete id="deleteIfDeptCl">
DELETE FROM PTL.T_IF_DEPT_CL
	</delete>



<!-- 부서 분류 인터페이스 등록 -->
	<insert id="insertIfDeptCl" parameterType="map">
INSERT INTO PTL.T_IF_DEPT_CL (DEPT_CODE,DEPT_NM,GROUP_CODE,UP_GROUP_CODE,ORD_SEQ,LV,DEPT_PATH,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT) VALUES
		<foreach collection="deptinfo" item="i" separator=",">
(COALESCE(NULLIF(#{i.deptCode},''),#{i.groupCode}),#{i.deptNm},#{i.groupCode},#{i.upGroupCode},COALESCE(NULLIF(#{i.ordSeq},''),'99999')::INTEGER,COALESCE(NULLIF(#{i.lv},''),NULL)::INTEGER,#{i.deptPath},'I','SYSTEM',NOW(),'SYSTEM',NOW())
		</foreach>
	</insert>



<!-- 삭제 부서 -->
	<update id="syncDeleteDeptCl">
UPDATE PTL.T_DEPT_CL SET
    MODI_SE = 'D',
    USE_YN = 'N',
    MODI_ID = 'SYSTEM',
    MODI_DT = NOW()
WHERE MODI_SE = 'C'
  AND DEPT_CODE NOT IN (SELECT DEPT_CODE FROM PTL.T_IF_DEPT_CL)
	</update>
<!-- 변경 부서 -->
	<update id="syncUpdateDeptCl">
UPDATE PTL.T_DEPT_CL T SET
    DEPT_NM = S.DEPT_NM,
    UP_DEPT_CODE = REGEXP_REPLACE(S.UP_GROUP_CODE,'(^GS)(.+)','\2'),
    LV = S.LV,
    DEPT_PATH = S.DEPT_PATH,
    GROUP_CODE = S.GROUP_CODE,
    UP_GROUP_CODE = S.UP_GROUP_CODE,
    MODI_SE = 'U',
    MODI_ID = 'SYSTEM',
    MODI_DT = NOW()
FROM PTL.T_IF_DEPT_CL S
WHERE T.DEPT_CODE = S.DEPT_CODE
  AND (T.DEPT_NM != S.DEPT_NM OR T.GROUP_CODE != S.GROUP_CODE OR T.UP_GROUP_CODE != S.UP_GROUP_CODE OR T.LV != S.LV OR T.DEPT_PATH != S.DEPT_PATH)
	</update>
<!-- 삭제 부서 중 변경 값 없는 부서 복구 -->
	<update id="syncDeleteRecoveryDeptCl">
UPDATE PTL.T_DEPT_CL SET
    MODI_SE = 'U',
    USE_YN = 'Y',
    MODI_ID = 'SYSTEM',
    MODI_DT = NOW()
WHERE MODI_SE = 'R'
  AND DEPT_CODE IN (SELECT DEPT_CODE FROM PTL.T_IF_DEPT_CL)
	</update>
<!-- 신규 부서 -->
	<insert id="syncInsertDeptCl">
INSERT INTO PTL.T_DEPT_CL (DEPT_CODE,DEPT_NM,UP_DEPT_CODE,ORD_SEQ,LV,DEPT_PATH,GROUP_CODE,UP_GROUP_CODE,USE_YN,MODI_SE,RGST_ID,RGST_DT,MODI_ID,MODI_DT)
SELECT
    S.DEPT_CODE,S.DEPT_NM,REGEXP_REPLACE(S.UP_GROUP_CODE,'(^GS)(.+)','\2'),S.ORD_SEQ,S.LV,S.DEPT_PATH,S.GROUP_CODE,S.UP_GROUP_CODE,'Y','I','SYSTEM',NOW(),'SYSTEM',NOW()
FROM PTL.T_IF_DEPT_CL S
LEFT OUTER JOIN PTL.T_DEPT_CL T ON T.DEPT_CODE = S.DEPT_CODE
WHERE T.DEPT_CODE IS NULL
	</insert>
<!-- 부서 수정 구분 정리 -->
	<update id="updateModiSeDeptCl">
UPDATE PTL.T_DEPT_CL SET MODI_SE = CASE MODI_SE WHEN 'D' THEN 'R' ELSE 'C' END WHERE MODI_SE IN ('I','U','D')
	</update>


</mapper>
